steps:
  # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µãƒ¼ãƒ“ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¨é©åˆ‡ãªå‡¦ç†ã®å®Ÿè¡Œ
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== ã‚µãƒ¼ãƒ“ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯ ==="
        
        # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if gcloud run services describe hello-world --region=${_REGION} 2>/dev/null; then
          echo "âœ… æ—¢å­˜ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          MODE="update"
          
          echo "ç¾åœ¨ã®è¨­å®š:"
          gcloud run services describe hello-world --region=${_REGION} \
            --format="table(
              status.url,
              status.ingress,
              spec.template.spec.containers[0].resources.limits.memory,
              spec.template.spec.timeoutSeconds,
              spec.template.metadata.annotations['autoscaling.knative.dev/maxScale']
            )"
        else
          echo "ğŸ“ æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          MODE="create"
        fi
        
        echo ""
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰: $MODE"
        echo "$MODE" > /workspace/mode.txt
        
        echo ""
        echo "=== ç½®æ›å¤‰æ•°ã®ç¢ºèª ==="
        echo "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ${_REGION}"
        echo "ãƒ¡ãƒ¢ãƒª: ${_MEMORY}"
        echo "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${_TIMEOUT}"
        echo "æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: ${_MAX_INSTANCES}"
        echo "æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: ${_MIN_INSTANCES}"
        echo "ç’°å¢ƒ: ${_ENVIRONMENT}"
        echo ""
    id: 'check-service'

  # ã‚¹ãƒ†ãƒƒãƒ—2: é©åˆ‡ãªãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚’å®Ÿè¡Œ
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        MODE=$(cat /workspace/mode.txt)
        
        if [ "$MODE" = "update" ]; then
          echo "=== æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–° ==="
          
          # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æ›´æ–°
          gcloud run services update hello-world \
            --region=${_REGION} \
            --no-allow-unauthenticated \
            --ingress=all \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --max-instances=${_MAX_INSTANCES} \
            --min-instances=${_MIN_INSTANCES} \
            --set-env-vars=ENVIRONMENT=${_ENVIRONMENT},ACCESS_TYPE=authenticated,MODE=update \
            --verbosity=info
          
          echo "âœ… æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°å®Œäº†"
          
        else
          echo "=== æ–°è¦é–¢æ•°ã®ä½œæˆ ==="
          
          # Cloud Run Functionsã¨ã—ã¦æ–°è¦ä½œæˆ
          gcloud functions deploy hello-world \
            --gen2 \
            --runtime=python311 \
            --region=${_REGION} \
            --source=./cloud_run_functions \
            --entry-point=hello_world \
            --trigger=http \
            --no-allow-unauthenticated \
            --ingress-settings=all \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --max-instances=${_MAX_INSTANCES} \
            --min-instances=${_MIN_INSTANCES} \
            --set-env-vars=ENVIRONMENT=${_ENVIRONMENT},ACCESS_TYPE=authenticated,MODE=create \
            --verbosity=info
          
          echo "âœ… æ–°è¦é–¢æ•°ä½œæˆå®Œäº†"
        fi
        
        echo ""
        echo "=== ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®è¨­å®šç¢ºèª ==="
        gcloud run services describe hello-world --region=${_REGION} \
          --format="table(
            status.url,
            status.ingress,
            spec.template.spec.containers[0].resources.limits.memory,
            spec.template.spec.timeoutSeconds,
            spec.template.metadata.annotations['autoscaling.knative.dev/maxScale'],
            spec.template.metadata.annotations['autoscaling.knative.dev/minScale']
          )"
    id: 'smart-deploy'
    waitFor: ['check-service']


substitutions:
  _REGION: 'asia-northeast1'
  _MEMORY: '256Mi'
  _TIMEOUT: '60s'
  _MAX_INSTANCES: '5'
  _MIN_INSTANCES: '0'
  _ENVIRONMENT: 'development'

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '1200s'