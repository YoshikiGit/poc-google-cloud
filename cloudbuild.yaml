steps:
  # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µãƒ¼ãƒ“ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== ã‚µãƒ¼ãƒ“ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯ ==="
        
        # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if gcloud run services describe hello-world --region=${_REGION} 2>/dev/null; then
          echo "âœ… æ—¢å­˜ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          echo "update" > /workspace/deploy_mode.txt
          
          echo "ç¾åœ¨ã®è¨­å®š:"
          gcloud run services describe hello-world --region=${_REGION} \
            --format="table(
              status.url,
              status.ingress,
              spec.template.spec.containers[0].resources.limits.memory,
              spec.template.spec.timeoutSeconds,
              spec.template.metadata.annotations['autoscaling.knative.dev/maxScale']
            )"
        else
          echo "ğŸ“ æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "create" > /workspace/deploy_mode.txt
        fi
        
        DEPLOY_MODE=$(cat /workspace/deploy_mode.txt)
        echo ""
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰: $DEPLOY_MODE"
        
        echo ""
        echo "=== ç½®æ›å¤‰æ•°ã®ç¢ºèª ==="
        echo "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ${_REGION}"
        echo "ãƒ¡ãƒ¢ãƒª: ${_MEMORY}"
        echo "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${_TIMEOUT}"
        echo "æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: ${_MAX_INSTANCES}"
        echo "æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: ${_MIN_INSTANCES}"
        echo "ç’°å¢ƒ: ${_ENVIRONMENT}"
        echo ""
    id: 'check-service'

  # ã‚¹ãƒ†ãƒƒãƒ—2: æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆæ¡ä»¶ä»˜ãå®Ÿè¡Œï¼‰
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        DEPLOY_MODE=$(cat /workspace/deploy_mode.txt)
        
        if [ "$DEPLOY_MODE" = "update" ]; then
          echo "=== æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–° ==="
          
          # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æ›´æ–°
          gcloud run services update hello-world \
            --region=${_REGION} \
            --no-allow-unauthenticated \
            --ingress=all \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --max-instances=${_MAX_INSTANCES} \
            --min-instances=${_MIN_INSTANCES} \
            --set-env-vars=ENVIRONMENT=${_ENVIRONMENT},ACCESS_TYPE=authenticated \
            --verbosity=info
          
          echo "âœ… æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°å®Œäº†"
        else
          echo "æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        fi
    id: 'update-service'
    waitFor: ['check-service']

  # ã‚¹ãƒ†ãƒƒãƒ—3: æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆï¼ˆæ¡ä»¶ä»˜ãå®Ÿè¡Œï¼‰
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        DEPLOY_MODE=$(cat /workspace/deploy_mode.txt)
        
        if [ "$DEPLOY_MODE" = "create" ]; then
          echo "=== æ–°è¦é–¢æ•°ã®ä½œæˆ ==="
          
          # Cloud Run Functionsã¨ã—ã¦æ–°è¦ä½œæˆ
          gcloud functions deploy hello-world \
            --gen2 \
            --runtime=python311 \
            --region=${_REGION} \
            --source=./cloud_run_functions \
            --entry-point=hello_world \
            --trigger=http \
            --no-allow-unauthenticated \
            --ingress-settings=all \
            --memory=${_MEMORY} \
            --timeout=${_TIMEOUT} \
            --max-instances=${_MAX_INSTANCES} \
            --min-instances=${_MIN_INSTANCES} \
            --set-env-vars=ENVIRONMENT=${_ENVIRONMENT},ACCESS_TYPE=authenticated \
            --verbosity=info
          
          echo "âœ… æ–°è¦é–¢æ•°ä½œæˆå®Œäº†"
        else
          echo "æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã£ãŸãŸã‚ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        fi
    id: 'create-service'
    waitFor: ['check-service']


substitutions:
  _REGION: 'asia-northeast1'
  _MEMORY: '256Mi'
  _TIMEOUT: '60s'
  _MAX_INSTANCES: '5'
  _MIN_INSTANCES: '0'
  _ENVIRONMENT: 'development'

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '1200s'